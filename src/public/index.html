<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swatticus Trading Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --accent-gold: #d4af37;
            --accent-light-gold: #f1c40f;
            --text-primary: #f0f0f0;
            --text-secondary: #c0c0c0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
        }
        .btn-primary {
            background-color: var(--accent-gold);
            color: #000;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .btn-primary:hover {
            background-color: var(--accent-light-gold);
            transform: scale(1.05);
        }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .card {
            background-color: var(--bg-secondary);
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        .card:hover {
            transform: translateY(-5px);
            border: 1px solid rgba(212, 175, 55, 0.4);
        }
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        #activityLog::-webkit-scrollbar {
            width: 8px;
        }
        #activityLog::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 10px;
        }
        #activityLog::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 10px;
        }
        #activityLog::-webkit-scrollbar-thumb:hover {
            background: var(--accent-light-gold);
        }
        .new-trade {
            animation: highlight 2s ease-in-out;
        }
        @keyframes highlight {
            0% { background-color: rgba(212, 175, 55, 0.2); }
            100% { background-color: transparent; }
        }
        .log-entry {
            transition: all 0.3s ease;
        }
        
        /* Profit Management Section Styling */
        .profit-management-card {
          border-radius: 8px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          margin-bottom: 1.5rem;
          overflow: hidden;
          border: none;
        }
        
        .profit-management-card .card-header {
          background: linear-gradient(45deg, #d4af37, #f1c40f);
          color: black;
          font-weight: 500;
          padding: 15px 20px;
          border-bottom: none;
        }
        
        .profit-management-card .card-body {
          padding: 20px;
          background-color: #1a1a1a;
        }
        
        /* Button styling */
        #consolidate-profits-btn {
          background: linear-gradient(45deg, #d4af37, #f1c40f);
          border: none;
          color: black;
          font-weight: 500;
          padding: 10px 20px;
          border-radius: 6px;
          transition: all 0.3s ease;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        
        /* Status alert styling */
        #consolidation-status {
          border-radius: 6px;
          padding: 12px 15px;
          margin-top: 15px;
          animation: fadeIn 0.3s ease;
        }
        
        /* Spinner for loading state */
        .spinner {
          display: inline-block;
          width: 18px;
          height: 18px;
          border: 3px solid rgba(255, 255, 255, 0.3);
          border-radius: 50%;
          border-top-color: var(--accent-gold);
          animation: spin 1s ease-in-out infinite;
          margin-right: 10px;
          vertical-align: text-bottom;
        }
        
        /* Animation for spinner */
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        
        /* Animation for alert fadeIn */
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        /* Gold Text Accents */
        .text-gold {
            color: var(--accent-gold);
        }
        
        .text-light-gold {
            color: var(--accent-light-gold);
        }
        
        /* Gold border accents */
        .border-gold {
            border-color: var(--accent-gold);
        }
    </style>
</head>
<body class="bg-[var(--bg-dark)] text-[var(--text-primary)] p-4 md:p-8">
    <div class="container mx-auto max-w-7xl">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 md:mb-8 text-[var(--accent-gold)]">
            Swatticus Trading Bot Dashboard
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
            <!-- Connection Status -->
            <div class="card">
                <h2 class="text-xl md:text-2xl font-semibold mb-4 text-[var(--accent-gold)]">Connection</h2>
                <div id="connectionStatus" class="text-center">
                    <p id="socketStatus" class="font-bold text-yellow-400">ðŸŸ¡ Connecting...</p>
                    <p id="walletAddress" class="text-sm text-[var(--text-secondary)] mt-2">
                        Wallet: Not Connected
                    </p>
                </div>
                <div class="mt-4 space-y-2">
                    <button id="connectWallet" class="btn-primary w-full py-2 rounded-lg">
                        Connect Wallet
                    </button>
                    <button id="startBot" class="btn-primary w-full py-2 rounded-lg btn-disabled" disabled>
                        Start Trading Bot
                    </button>
                    <button id="stopBot" class="btn-primary w-full py-2 rounded-lg btn-disabled" disabled>
                        Stop Trading Bot
                    </button>
                </div>
            </div>

            <!-- Wallet Summary -->
            <div class="card">
                <h2 class="text-xl md:text-2xl font-semibold mb-4 text-[var(--accent-gold)]">Wallet Summary</h2>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-[var(--text-secondary)]">Bot Status</span>
                        <span id="botStatus" class="font-bold text-yellow-400">Inactive</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-[var(--text-secondary)]">SOL Balance</span>
                        <span id="solBalance" class="font-bold text-gold">0.00 SOL</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-[var(--text-secondary)]">USDC Balance</span>
                        <span id="usdcBalance" class="font-bold text-gold">0.00 USDC</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-[var(--text-secondary)]">USDT Balance</span>
                        <span id="usdtBalance" class="font-bold text-gold">0.00 USDT</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-[var(--text-secondary)]">mSOL Balance</span>
                        <span id="msolBalance" class="font-bold text-gold">0.00 mSOL</span>
                    </div>
                    <div class="flex justify-between mt-2 pt-2 border-t border-gray-700">
                        <span class="text-[var(--text-secondary)]">Total SOL Equivalent</span>
                        <span id="totalSolEquivalent" class="font-bold text-light-gold">0.00 SOL</span>
                    </div>
                </div>
            </div>

            <!-- Trading Pairs -->
            <div class="card">
                <h2 class="text-xl md:text-2xl font-semibold mb-4 text-[var(--accent-gold)]">Trading Pairs</h2>
                <div id="tradingPairs" class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-[var(--text-secondary)]">SOL/USDC</span>
                        <span id="sol-usdc-status" class="text-yellow-400 font-bold text-sm">Inactive</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[var(--text-secondary)]">SOL/USDT</span>
                        <span id="sol-usdt-status" class="text-yellow-400 font-bold text-sm">Inactive</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[var(--text-secondary)]">USDC/SOL</span>
                        <span id="usdc-sol-status" class="text-yellow-400 font-bold text-sm">Inactive</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[var(--text-secondary)]">USDT/SOL</span>
                        <span id="usdt-sol-status" class="text-yellow-400 font-bold text-sm">Inactive</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[var(--text-secondary)]">mSOL/SOL</span>
                        <span id="msol-sol-status" class="text-yellow-400 font-bold text-sm">Inactive</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[var(--text-secondary)]">SOL/mSOL</span>
                        <span id="sol-msol-status" class="text-yellow-400 font-bold text-sm">Inactive</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mt-4 md:mt-6">
            <!-- Total Profits -->
            <div class="card">
                <h2 class="text-xl md:text-2xl font-semibold mb-4 text-[var(--accent-gold)]">Total Profits</h2>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-[var(--text-secondary)]">Total Realized</span>
                        <span id="totalRealized" class="font-bold text-light-gold">0.00 SOL</span>
                    </div>
                    <div class="flex justify-between border-t border-gray-700 pt-2 mt-2">
                        <span class="text-[var(--text-secondary)]">Active Trades</span>
                        <span id="activeTrades" class="font-bold text-gold">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-[var(--text-secondary)]">Completed Trades</span>
                        <span id="completedTrades" class="font-bold text-gold">0</span>
                    </div>
                    <div class="flex justify-between border-t border-gray-700 pt-2 mt-2 text-sm">
                        <span class="text-[var(--text-secondary)]">Auto-Consolidated</span>
                        <span id="autoConsolidated" class="font-bold text-gold">0.00000 SOL</span>
                    </div>
                </div>
            </div>
            <!-- Recent Trades -->
            <div class="card">
                <h2 class="text-xl md:text-2xl font-semibold mb-4 text-[var(--accent-gold)]">Recent Trades</h2>
                <div id="recentTrades" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-[var(--text-secondary)] text-center">No recent trades</p>
                </div>
            </div>
            
            <!-- Active Trades -->
            <div class="card">
                <h2 class="text-xl md:text-2xl font-semibold mb-4 text-[var(--accent-gold)]">Active Trades</h2>
                <div id="activeTradesList" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-[var(--text-secondary)] text-center">No active trades</p>
                </div>
            </div>
        </div>
        
        <!-- Price Data -->
        <div class="mt-4 md:mt-6 card">
            <h2 class="text-xl md:text-2xl font-semibold mb-4 text-[var(--accent-gold)]">Live Price Data</h2>
            <div id="priceData" class="grid grid-cols-2 gap-4 md:grid-cols-3">
                <div class="flex justify-between">
                    <span class="text-[var(--text-secondary)]">SOL/USDC</span>
                    <span id="sol-usdc-price" class="font-bold text-gold animate-pulse">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[var(--text-secondary)]">SOL/USDT</span>
                    <span id="sol-usdt-price" class="font-bold text-gold animate-pulse">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[var(--text-secondary)]">USDC/SOL</span>
                    <span id="usdc-sol-price" class="font-bold text-gold animate-pulse">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[var(--text-secondary)]">USDT/SOL</span>
                    <span id="usdt-sol-price" class="font-bold text-gold animate-pulse">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[var(--text-secondary)]">mSOL/SOL</span>
                    <span id="msol-sol-price" class="font-bold text-gold animate-pulse">Loading...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-[var(--text-secondary)]">SOL/mSOL</span>
                    <span id="sol-msol-price" class="font-bold text-gold animate-pulse">Loading...</span>
                </div>
            </div>
        </div>
        
        <!-- Opportunity Log -->
        <div class="mt-4 md:mt-6 card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl md:text-2xl font-semibold text-[var(--accent-gold)]">Bot Activity Log</h2>
                <button id="clearLog" class="text-sm text-[var(--text-secondary)] hover:text-gold">Clear</button>
            </div>
            <div id="activityLog" class="space-y-2 h-80 overflow-y-auto bg-[var(--bg-dark)] p-4 rounded-lg border border-gold border-opacity-20">
                <p class="text-[var(--text-secondary)]">Bot is inactive. Start the bot to see activity.</p>
            </div>
        </div>
    </div>


    <script>
       // Complete Dashboard JavaScript for Swatticus Trading Bot

document.addEventListener('DOMContentLoaded', function() {
    // Token balances
    let walletBalances = {
        SOL: 0.0,
        USDC: 0.0,
        USDT: 0.0,
        mSOL: 0.0
    };

    // Token prices for conversions
    let tokenPrices = {
        'SOL/USDC': 0,
        'SOL/USDT': 0,
        'USDC/SOL': 0,
        'USDT/SOL': 0,
        'mSOL/SOL': 0,
        'SOL/mSOL': 0
    };

    // WebSocket connection
    let socket;
    let isWalletConnected = false;
    let isBotRunning = false;
    let totalTrades = 0;

    // Profit tracking by token
    let profits = {
        SOL: 0,
        USDC: 0,
        USDT: 0,
        mSOL: 0,
        consolidated: 0 // Track consolidated profit separately
    };

    // Active trades information
    let activeTradesList = [];

    // UI elements
    const activityLog = document.getElementById('activityLog');
    const botStatus = document.getElementById('botStatus');
    const solBalance = document.getElementById('solBalance');
    const usdcBalance = document.getElementById('usdcBalance');
    const usdtBalance = document.getElementById('usdtBalance');
    const msolBalance = document.getElementById('msolBalance');
    const totalSolEquivalent = document.getElementById('totalSolEquivalent');
    const totalRealized = document.getElementById('totalRealized');
    const autoConsolidatedEl = document.getElementById('autoConsolidated');
    const activeTrades = document.getElementById('activeTrades');
    const completedTrades = document.getElementById('completedTrades');
    const startBotBtn = document.getElementById('startBot');
    const stopBotBtn = document.getElementById('stopBot');
    const clearLogBtn = document.getElementById('clearLog');
    const socketStatus = document.getElementById('socketStatus');
    const walletAddress = document.getElementById('walletAddress');
    const recentTrades = document.getElementById('recentTrades');
    const activeTradesList_el = document.getElementById('activeTradesList');

    // Price elements
    const priceElements = {
        'SOL/USDC': document.getElementById('sol-usdc-price'),
        'SOL/USDT': document.getElementById('sol-usdt-price'),
        'USDC/SOL': document.getElementById('usdc-sol-price'),
        'USDT/SOL': document.getElementById('usdt-sol-price'),
        'mSOL/SOL': document.getElementById('msol-sol-price'),
        'SOL/mSOL': document.getElementById('sol-msol-price')
    };

    // Status elements
    const pairStatusElements = {
        'SOL/USDC': document.getElementById('sol-usdc-status'),
        'SOL/USDT': document.getElementById('sol-usdt-status'),
        'USDC/SOL': document.getElementById('usdc-sol-status'),
        'USDT/SOL': document.getElementById('usdt-sol-status'),
        'mSOL/SOL': document.getElementById('msol-sol-status'),
        'SOL/mSOL': document.getElementById('sol-msol-status')
    };

    // Function to add an active trade
    function addActiveTrade(trade) {
        activeTradesList.push(trade);
        updateActiveTradesDisplay();
        // Update active trades count
        activeTrades.textContent = activeTradesList.length;
    }

    // Function to remove an active trade (when completed)
    function removeActiveTrade(txid) {
        activeTradesList = activeTradesList.filter(trade => trade.txid !== txid);
        updateActiveTradesDisplay();
        // Update active trades count
        activeTrades.textContent = activeTradesList.length;
    }

    // Function to update the active trades display
    function updateActiveTradesDisplay() {
        const activeTradesContainer = document.getElementById('activeTradesList');
        if (!activeTradesContainer) return;
        
        if (activeTradesList.length === 0) {
            activeTradesContainer.innerHTML = '<p class="text-[var(--text-secondary)] text-center">No active trades</p>';
            return;
        }
        
        activeTradesContainer.innerHTML = '';
        activeTradesList.forEach(trade => {
            const tradeEl = document.createElement('div');
            tradeEl.className = 'flex justify-between items-center p-2 border-b border-gray-700';
            
            // Format start time
            const startTime = new Date(trade.startTime).toLocaleTimeString();
            
            tradeEl.innerHTML = `
                <div>
                    <div class="font-medium">${trade.pair}</div>
                    <div class="text-xs text-[var(--text-secondary)]">Started: ${startTime}</div>
                </div>
                <span class="font-bold text-[var(--accent-gold)]">
                    ${trade.amount.toFixed(6)} ${trade.inputToken}
                </span>
            `;
            
            activeTradesContainer.appendChild(tradeEl);
        });
    }

    // Add a log message to the activity log
    function addLogMessage(message, type = 'info') {
        const now = new Date();
        const timestamp = now.toLocaleTimeString();
        const logItem = document.createElement('div');
        logItem.className = 'log-entry';
        
        // Set color based on message type
        let colorClass = 'text-[var(--text-secondary)]'; // default
        if (type === 'success') {
            colorClass = 'text-green-400';
        } else if (type === 'error') {
            colorClass = 'text-red-400';
        } else if (type === 'warning') {
            colorClass = 'text-yellow-400';
        } else if (type === 'trade') {
            colorClass = 'text-[var(--accent-gold)]';
        } else if (type === 'opportunity') {
            colorClass = 'text-blue-400';
        } else if (type === 'profit') {
            colorClass = 'text-purple-400';
        }
        
        // Format message with timestamp
        logItem.innerHTML = `<span class="text-xs opacity-70">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
        
        // Add to log and scroll to bottom
        activityLog.appendChild(logItem);
        activityLog.scrollTop = activityLog.scrollHeight;
        
        // Limit log entries (keep last 100)
        while (activityLog.children.length > 100) {
            activityLog.removeChild(activityLog.firstChild);
        }
        
        // Add brief highlight animation
        setTimeout(() => {
            logItem.classList.add('new-trade');
        }, 100);
    }

    // Calculate total SOL equivalent balance
    function calculateTotalSolEquivalent(balances) {
        let total = balances.SOL || 0;
        
        // Convert USDC to SOL
        if (balances.USDC && tokenPrices['USDC/SOL']) {
            total += balances.USDC * tokenPrices['USDC/SOL'];
        }
        
        // Convert USDT to SOL
        if (balances.USDT && tokenPrices['USDT/SOL']) {
            total += balances.USDT * tokenPrices['USDT/SOL'];
        }
        
        // Convert mSOL to SOL
        if (balances.mSOL && tokenPrices['mSOL/SOL']) {
            total += balances.mSOL * tokenPrices['mSOL/SOL'];
        }
        
        return total;
    }

    // Update UI with balance information
    function updateBalances(balances) {
        solBalance.textContent = `${(balances.SOL || 0).toFixed(4)} SOL`;
        usdcBalance.textContent = `${(balances.USDC || 0).toFixed(2)} USDC`;
        usdtBalance.textContent = `${(balances.USDT || 0).toFixed(2)} USDT`;
        msolBalance.textContent = `${(balances.mSOL || 0).toFixed(2)} mSOL`;
        
        // Update wallet balances for profit calculations
        walletBalances = balances;
        
        // Calculate and update total SOL equivalent
        const totalSol = calculateTotalSolEquivalent(balances);
        totalSolEquivalent.textContent = `${totalSol.toFixed(4)} SOL`;
    }

    // Initialize auto-consolidation tracking
    function initializeAutoConsolidation() {
        // Initialize data attribute if not set
        if (!autoConsolidatedEl.dataset.amount) {
            autoConsolidatedEl.dataset.amount = "0";
            autoConsolidatedEl.textContent = "0.000000 SOL";
        }
        
        // Request auto-consolidation data from server
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'get_auto_consolidation_data'
            }));
        }
    }

    // Handle auto-consolidation updates
    function handleAutoConsolidationUpdate(data) {
        console.log('Auto-consolidation update received:', data);
        
        // Extract consolidated amount
        let consolidatedAmount = 0;
        let fromToken = 'tokens';
        
        // Handle different message formats
        if (data.data) {
            consolidatedAmount = data.data.consolidatedAmount || 0;
            fromToken = data.data.fromToken || 'tokens';
            
            // If there's a total provided, use it directly
            if (data.data.totalConsolidated) {
                updateAutoConsolidatedDisplay(data.data.totalConsolidated);
            } else {
                // Otherwise add to current total
                addToAutoConsolidatedTotal(consolidatedAmount);
            }
        } else if (data.consolidatedAmount) {
            consolidatedAmount = data.consolidatedAmount;
            fromToken = data.fromToken || 'tokens';
            
            if (data.totalConsolidated) {
                updateAutoConsolidatedDisplay(data.totalConsolidated);
            } else {
                addToAutoConsolidatedTotal(consolidatedAmount);
            }
        }
        
        // Update wallet balances if provided
        if (data.balances) {
            updateBalances(data.balances);
        }
        
        // Log the consolidation action
        addLogMessage(`ðŸ”„ Auto-consolidated ${consolidatedAmount.toFixed(6)} ${fromToken} to SOL`, 'profit');
        
        // Update total realized profit to include consolidated amount
        updateTotalRealized();
    }

    // Function to update the auto-consolidated display
    function updateAutoConsolidatedDisplay(totalAmount) {
        if (!autoConsolidatedEl) return;
        
        // Parse as float to ensure proper handling
        const amount = parseFloat(totalAmount);
        
        // Update data attribute for tracking
        autoConsolidatedEl.dataset.amount = amount.toString();
        
        // Update display
        autoConsolidatedEl.textContent = `${amount.toFixed(6)} SOL`;
        
        // Also update consolidated profit tracking
        profits.consolidated = amount;
    }

    // Function to add to the current auto-consolidated total
    function addToAutoConsolidatedTotal(amountToAdd) {
        if (!autoConsolidatedEl) return;
        
        // Get current amount or initialize to 0
        let currentAmount = 0;
        if (autoConsolidatedEl.dataset.amount) {
            currentAmount = parseFloat(autoConsolidatedEl.dataset.amount);
        }
        
        // Add the new amount
        const newTotal = currentAmount + parseFloat(amountToAdd);
        
        // Update tracking and display
        autoConsolidatedEl.dataset.amount = newTotal.toString();
        autoConsolidatedEl.textContent = `${newTotal.toFixed(6)} SOL`;
        
        // Also update consolidated profit tracking
        profits.consolidated = newTotal;
    }

    // Function to update total realized profit display
    function updateTotalRealized(explicitValue = null) {
        // If an explicit value is provided, use it
        if (explicitValue !== null) {
            totalRealized.textContent = `${explicitValue.toFixed(6)} SOL`;
            return;
        }
    
        // Get the SOL profit value
        const solProfit = profits.SOL || 0;
        
        // Get the auto-consolidated amount
        const autoConsolidatedAmount = profits.consolidated || 0;
        
        // Calculate total realized profit
        const totalAmount = solProfit + autoConsolidatedAmount;
        
        // Update the total realized display
        totalRealized.textContent = `${totalAmount.toFixed(6)} SOL`;
    }

    // Handle auto-consolidation data response
    function handleAutoConsolidationData(data) {
        if (!data) return;
        
        // Update total consolidated amount if provided
        if (data.totalConsolidated) {
            updateAutoConsolidatedDisplay(data.totalConsolidated);
            
            // Add log message
            if (parseFloat(data.totalConsolidated) > 0) {
                addLogMessage(`Loaded auto-consolidated profit data: ${parseFloat(data.totalConsolidated).toFixed(6)} SOL`, 'profit');
            }
        }
        
        // Update total realized to include consolidated amount
        updateTotalRealized();
        
        // Update recent consolidations if provided
        if (data.recentConsolidations && data.recentConsolidations.length > 0) {
            // Could display these in a consolidation history view if needed
            console.log('Recent consolidations:', data.recentConsolidations);
        }
    }

    // Update price display with current token prices
    function updatePriceDisplay() {
        for (const [pair, element] of Object.entries(priceElements)) {
            if (tokenPrices[pair]) {
                // Format based on pair type
                if (pair.includes('/SOL')) {
                    element.textContent = tokenPrices[pair].toFixed(6);
                } else {
                    element.textContent = tokenPrices[pair].toFixed(2);
                }
                element.classList.remove('animate-pulse');
            }
        }
    }

    // Update profit display
    function updateProfitsByToken(profitData) {
        if (profitData) {
            // Update our profit tracking
            if (profitData.SOL !== undefined) profits.SOL = profitData.SOL;
            if (profitData.USDC !== undefined) profits.USDC = profitData.USDC;
            if (profitData.USDT !== undefined) profits.USDT = profitData.USDT;
            if (profitData.mSOL !== undefined) profits.mSOL = profitData.mSOL;
            
            // Update display
            updateTotalRealized();
        }
    }

    // Update trading pair status
    function updatePairStatus(active = false) {
        for (const [pair, element] of Object.entries(pairStatusElements)) {
            element.textContent = active ? 'Active' : 'Inactive';
            element.className = active ? 'text-green-400 font-bold text-sm' : 'text-yellow-400 font-bold text-sm';
        }
    }

    // Update recent trades display
    function updateRecentTrades(trades) {
        const tradesContainer = document.getElementById('recentTrades');
        
        if (trades && trades.length > 0) {
            tradesContainer.innerHTML = '';
            
            trades.forEach(trade => {
                const isPositive = trade.profit > 0;
                const tradeEl = document.createElement('div');
                tradeEl.className = 'flex justify-between items-center p-2 border-b border-gray-700';
                
                // Format timestamp
                let timeString;
                if (typeof trade.timestamp === 'string') {
                    const tradeDate = new Date(trade.timestamp);
                    timeString = tradeDate.toLocaleTimeString();
                } else {
                    timeString = new Date().toLocaleTimeString();
                }
                
                // Get token for profit
                const outputToken = trade.outputToken || 'SOL';
                
                tradeEl.innerHTML = `
                    <div>
                        <div class="font-medium">${trade.pair || trade.inputToken + '/' + outputToken}</div>
                        <div class="text-xs text-[var(--text-secondary)]">${timeString}</div>
                    </div>
                    <span class="font-bold ${isPositive ? 'text-green-400' : 'text-red-400'}">
                        ${isPositive ? '+' : ''}${trade.profit.toFixed(6)} SOL
                    </span>
                `;
                
                tradesContainer.appendChild(tradeEl);
            });
            
            // Update completed trades counter
            completedTrades.textContent = trades.length;
            totalTrades = trades.length;
        } else {
            tradesContainer.innerHTML = '<p class="text-[var(--text-secondary)] text-center">No recent trades</p>';
        }
    }

    // Add a new trade to recent trades
    function addTradeToRecent(trade) {
        const tradesContainer = document.getElementById('recentTrades');
        
        // Remove "No recent trades" message if present
        if (tradesContainer.children.length === 1 && 
            tradesContainer.children[0].tagName === 'P') {
            tradesContainer.innerHTML = '';
        }
        
        // Create trade element
        const isPositive = trade.profit > 0;
        const tradeEl = document.createElement('div');
        tradeEl.className = 'flex justify-between items-center p-2 border-b border-gray-700 new-trade';
        
        // Format timestamp
        const timeString = new Date().toLocaleTimeString();
        
        tradeEl.innerHTML = `
            <div>
                <div class="font-medium">${trade.pair}</div>
                <div class="text-xs text-[var(--text-secondary)]">${timeString}</div>
            </div>
            <span class="font-bold ${isPositive ? 'text-green-400' : 'text-red-400'}">
                ${isPositive ? '+' : ''}${trade.profit.toFixed(6)} SOL
            </span>
        `;
        
        // Add to container
        tradesContainer.insertBefore(tradeEl, tradesContainer.firstChild);
        
        // Limit to 10 recent trades
        while (tradesContainer.children.length > 10) {
            tradesContainer.removeChild(tradesContainer.lastChild);
        }
        
        // Update completed trades counter
        totalTrades++;
        completedTrades.textContent = totalTrades;
        
        // Update profits tracking
        if (trade.outputToken === 'SOL') {
            profits.SOL += trade.profit;
        }
        
        // Update profit display
        updateTotalRealized();
    }

    // WebSocket message handler
    function handleWebSocketMessage(data) {
        console.log('Received message:', data.type);
        
        // Handle different types of messages
        switch(data.type) {
            case 'wallet_state':
            case 'wallet_connected':
                updateWalletState(data);
                break;
                
            case 'balance_update':
                updateBalances(data.balances);
                // Update total SOL equivalent if available
                if (data.totalSolEquivalent) {
                    totalSolEquivalent.textContent = `${data.totalSolEquivalent.toFixed(4)} SOL`;
                }
                addLogMessage('Wallet balances updated', 'info');
                break;
                
            case 'bot_status':
                updateBotStatus(data.status);
                break;
                
            case 'price_update':
                if (data.prices) {
                    // Update our token prices
                    tokenPrices = {...tokenPrices, ...data.prices};
                    updatePriceDisplay();
                }
                break;
                
            case 'trade_started':
                addLogMessage(`Starting trade: ${data.pair} for ${data.amount.toFixed(6)} tokens`, 'trade');
                activeTrades.textContent = parseInt(activeTrades.textContent) + 1;
                
                // Add to active trades list
                addActiveTrade({
                    txid: data.txid || 'pending',
                    pair: data.pair,
                    amount: data.amount,
                    inputToken: data.inputToken,
                    startTime: Date.now()
                });
                break;
                
            case 'trade_completed':
                handleTradeCompletion(data);
                break;
                
            case 'trade_update':
            case 'bot_state_update':
                updateBotState(data);
                break;
                
            case 'profit_update':
                updateProfitsByToken(data.profits);
                if (data.totalProfit !== undefined) {
                    updateTotalRealized(data.totalProfit);
                }
                break;
                
            case 'auto_consolidation_update':
                handleAutoConsolidationUpdate(data);
                break;
                
            case 'auto_consolidation_data':
                handleAutoConsolidationData(data);
                break;
                
            case 'log_message':
                addLogMessage(data.message, data.messageType || 'info');
                break;
                
            case 'trades_update':
                if (data.trades && data.trades.length > 0) {
                    updateRecentTrades(data.trades);
                }
                break;
                
            case 'active_trades_update':
                if (data.activeTrades) {
                    updateActiveTrades(data.activeTrades);
                    activeTrades.textContent = data.activeTrades.length;
                }
                break;
                
            case 'health_status':
                // Silent handler for health checks
                break;
                
            case 'error':
                addLogMessage(`Error: ${data.error}`, 'error');
                break;
                
            default:
                console.log('Unhandled message:', data);
        }
    }

    function updateWalletState(walletData) {
        if (walletData.data && walletData.data.connected) {
            isWalletConnected = true;
            const shortAddress = `${walletData.data.publicKey.substring(0, 6)}...${walletData.data.publicKey.substring(walletData.data.publicKey.length - 4)}`;
            walletAddress.textContent = `Wallet: ${shortAddress}`;
            
            // Enable start bot button
            startBotBtn.disabled = false;
            startBotBtn.classList.remove('btn-disabled');
            
            addLogMessage('Wallet connected', 'success');
        } else if (walletData.publicKey) {
            isWalletConnected = true;
            const shortAddress = `${walletData.publicKey.substring(0, 6)}...${walletData.publicKey.substring(walletData.publicKey.length - 4)}`;
            walletAddress.textContent = `Wallet: ${shortAddress}`;
            
            // Enable start bot button
            startBotBtn.disabled = false;
            startBotBtn.classList.remove('btn-disabled');
            
            addLogMessage('Wallet connected successfully', 'success');
        }
    }

    function updateBotState(data) {
        // Update balances with latest data
        if (data.totalBalance !== undefined) {
            solBalance.textContent = `${data.totalBalance.toFixed(4)} SOL`;
        }
        
        // Update active trades
        if (data.activeTrades !== undefined) {
            activeTrades.textContent = data.activeTrades;
        }
        
        // Update recent trades
        if (data.recentTrades) {
            updateRecentTrades(data.recentTrades);
        }
    }

    function updateBotStatus(status) {
        isBotRunning = status === 'running';
        
        // Update status display
        botStatus.textContent = isBotRunning ? 'Running' : 'Stopped';
        botStatus.className = isBotRunning ? 'font-bold text-green-400' : 'font-bold text-red-400';
        
        // Update trading pair statuses
        updatePairStatus(isBotRunning);
        
        // Update button states
        startBotBtn.disabled = isBotRunning;
        startBotBtn.classList.toggle('btn-disabled', isBotRunning);
        
        stopBotBtn.disabled = !isBotRunning;
        stopBotBtn.classList.toggle('btn-disabled', !isBotRunning);
        
        // Add log message
        if (isBotRunning) {
            addLogMessage('Bot started successfully', 'success');
            activityLog.innerHTML = ''; // Clear log when starting
            addLogMessage('Bot started. Initializing trading systems...', 'info');
        } else {
            addLogMessage('Bot stopped', 'warning');
        }
    }

    function handleTradeCompletion(data) {
        if (data.success) {
            const profitText = data.profit ? data.profit.toFixed(6) : '0.000000';
            const tokenType = data.token || 'SOL';
            
            addLogMessage(`Trade completed! Profit: ${profitText} ${tokenType}`, 'success');
            
            if (data.txid) {
                addLogMessage(`Transaction ID: ${data.txid.substring(0, 8)}...`, 'info');
                
                // Remove from active trades
                removeActiveTrade(data.txid);
            }
            
            // Update token-specific profit
            if (tokenType === 'SOL') {
                profits.SOL += data.profit || 0;
                walletBalances.SOL += data.profit || 0;
            } else if (tokenType === 'USDC') {
                profits.USDC += data.profit || 0;
                // Convert USDC profit to SOL and add to SOL profits for total tracking
                if (tokenPrices['SOL/USDC']) {
                    const solEquivalent = (data.profit || 0) / tokenPrices['SOL/USDC'];
                    profits.SOL += solEquivalent;
                }
                walletBalances.USDC += data.profit || 0;
            } else if (tokenType === 'USDT') {
                profits.USDT += data.profit || 0;
                // Convert USDT profit to SOL and add to SOL profits for total tracking
                if (tokenPrices['SOL/USDT']) {
                    const solEquivalent = (data.profit || 0) / tokenPrices['SOL/USDT'];
                    profits.SOL += solEquivalent;
                }
                walletBalances.USDT += data.profit || 0;
            } else if (tokenType === 'mSOL') {
                profits.mSOL += data.profit || 0;
                // Convert mSOL profit to SOL and add to SOL profits for total tracking
                if (tokenPrices['mSOL/SOL']) {
                    const solEquivalent = (data.profit || 0) * tokenPrices['mSOL/SOL'];
                    profits.SOL += solEquivalent;
                }
                walletBalances.mSOL += data.profit || 0;
            }
            
            // Update profit display
            updateTotalRealized();
            
            // Update balances display to reflect new amounts
            updateBalances(walletBalances);
            
            // Add to recent trades
            addTradeToRecent({
                pair: data.pair || 'Unknown',
                profit: data.profit || 0,
                timestamp: new Date(),
                txid: data.txid,
                inputToken: data.inputToken,
                outputToken: data.outputToken
            });
            
            // Update active trades count
            activeTrades.textContent = Math.max(0, parseInt(activeTrades.textContent) - 1);
        } else {
            addLogMessage(`Trade failed: ${data.error || 'Unknown error'}`, 'error');
            
            // Remove from active trades
            if (data.txid) {
                removeActiveTrade(data.txid);
            }
            
            // Update active trades count
            activeTrades.textContent = Math.max(0, parseInt(activeTrades.textContent) - 1);
        }
    }

    // Initialize WebSocket connection
    function initWebSocket() {
        // Get host from current URL
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}`;
        
        console.log(`Connecting to WebSocket at ${wsUrl}`);
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            console.log('WebSocket Connected');
            socketStatus.innerHTML = 'ðŸŸ¢ Connected';
            socketStatus.classList.remove('text-yellow-400');
            socketStatus.classList.add('text-green-400');
            addLogMessage('Connected to server', 'success');
            
            // Initialize auto-consolidation tracking
            initializeAutoConsolidation();
            
            // Send health check every 30 seconds
            setInterval(() => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'health_check' }));
                }
            }, 30000);
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            } catch (error) {
                console.error('WebSocket message error:', error);
                addLogMessage(`Error processing message: ${error.message}`, 'error');
            }
        };

        socket.onclose = () => {
            console.log('WebSocket Disconnected');
            socketStatus.innerHTML = 'ðŸ”´ Disconnected';
            socketStatus.classList.remove('text-green-400');
            socketStatus.classList.add('text-red-400');
            
            // Update bot status
            botStatus.textContent = 'Offline';
            botStatus.className = 'font-bold text-red-400';
            
            // Disable buttons
            startBotBtn.disabled = true;
            startBotBtn.classList.add('btn-disabled');
            stopBotBtn.disabled = true;
            stopBotBtn.classList.add('btn-disabled');
            
            // Add log message
            addLogMessage('Disconnected from server', 'error');
            
            // Attempt reconnection after 5 seconds
            setTimeout(initWebSocket, 5000);
        };
        
        socket.onerror = (error) => {
            console.error('WebSocket Error:', error);
            addLogMessage('Connection error', 'error');
        };
    }

    // Event Listeners
    document.getElementById('connectWallet').addEventListener('click', () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'connect_wallet'
            }));
            addLogMessage('Connecting wallet...', 'info');
        } else {
            addLogMessage('Cannot connect wallet: Server connection lost', 'error');
        }
    });

    // Start bot button
    startBotBtn.addEventListener('click', () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
            if (!isWalletConnected) {
                addLogMessage('Please connect wallet first', 'error');
                return;
            }
            
            socket.send(JSON.stringify({
                type: 'start_bot'
            }));
            addLogMessage('Starting bot...', 'info');
        } else {
            addLogMessage('Cannot start bot: Server connection lost', 'error');
        }
    });

    // Stop bot button
    stopBotBtn.addEventListener('click', () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'stop_bot'
            }));
            addLogMessage('Stopping bot...', 'warning');
        } else {
            addLogMessage('Cannot stop bot: Server connection lost', 'error');
        }
    });

    // Clear log button
    clearLogBtn.addEventListener('click', () => {
        activityLog.innerHTML = '';
        addLogMessage('Activity log cleared', 'info');
    });

    // Initialize the WebSocket connection
    initWebSocket();
    
    // Add initial log message
    addLogMessage('Dashboard initialized. Please connect your wallet to begin.', 'info');
});

// Global error handler
window.onerror = function(message, source, lineno, colno, error) {
    console.error('Global error:', message, 'at', source, 'line', lineno);
    if (activityLog) {
        addLogMessage(`JavaScript error: ${message}`, 'error');
    }
    return false;
};

// Unhandled promise rejection handler
window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    if (activityLog) {
        addLogMessage(`Unhandled promise rejection: ${event.reason}`, 'error');
    }
});

// Handle page visibility changes (suspend/resume WebSocket)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        console.log('Page hidden - consider suspending WebSocket');
    } else {
        console.log('Page visible - ensure WebSocket is connected');
        if (socket && socket.readyState !== WebSocket.OPEN) {
            initWebSocket();
        }
    }
});

// Add page unload handler for cleanup
window.addEventListener('beforeunload', function() {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
    }
});
    </script>
</body>
</html>